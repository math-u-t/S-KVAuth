# S-KVAuth

**S-KVAuth** は、Google Cloud を利用せずに「Googleでログイン」の機能を実現する方法です。

>[!IMPORTANT]
>## 注意点
>
>- 本物のOAuth認証ではないため、セキュリティや正規性が求められる場面では不適切な場合があります。
>- あくまで「簡易的なGoogleログイン」用途に向いています。

## プロジェクト構成 ##

| ディレクトリ / ファイル名 | 内容 |
| - | - |
| `/public/` | htmlファイル |
| `/functions/` | サーバーサイドのコード(`.gs`コード) |
| `/config/` | 設定ディレクトリ |
| `/docs/` | ドキュメントディレクトリ |
| `README.md` | このリポジトリの概要と開発ルール |

## 制限の突破

以下の制限下でも問題なく動作します。

- GoogleWorkspace管理者権限を持たない
- 「メールに送信する」を使用した認証ができない
- GoogleCloudConsoleにアクセスできない

## システム概要

このシステムは以下の構成で動作します。

1. ユーザーがサイトにアクセスする。この際にごくサイズが小さいページを経由することでキャッシュを読み取り、3で発行されたセッションIDが存在するか確認する。
---
2. セッションIDが存在する場合
3. ユーザーは、目標のサイトにアクセスできる。
---
2. セッションIDが間違っている場合
3. ユーザーはアクセスできない
---
2. セッションIDが存在しない場合
3. GoogleAppsScriptで作成したページ(`https://script.google.com/macros/s/<-- 長いので省略 -->/exec`)にアクセスしてユーザーのメールアドレスを取得する。
4. 取得したメールアドレスをcloudflare workersで作成したAPIを経由してアクセスして良いユーザーか認証する。

5. アクセスして良いユーザーの場合
6. ユーザーは、目標のサイトにアクセスできる。
---
5. アクセスしてはいけないユーザー・外部ユーザーの場合
6. ユーザーはアクセスできない

これらにより、Google Cloud Console を使った OAuth 設定なしで、Googleアカウントを用いたログイン機能を簡易的に実現できます。

## 使用技術

- GoogleAppsScript（`code.gs`）
- Cloudflare KV（APIサーバー）

## APIの形式

以下の形式です。

```json
{
    {authcode: <-- ランダムな生成されたコード -->},
    {useremail: <-- アクセスしたユーザーのメールアドレス -->},
    {authname: <-- 認証APIの名前 -->}
}
```

時間は、cloudflareの方で確認します。

## メリット

- Google Cloud Consoleの煩雑な設定が不要
- 軽量かつ素早く「Googleでログイン」風の認証が実装可能
- クライアントから直接GASを呼び出すため、認証処理がシンプル

## ライセンス

MITライセンス